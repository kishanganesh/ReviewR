---
title: "Support a New Relational Database Management System"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{add_a_database_module}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview

Database connections in ReviewR are created with the help of the [DBI Package](https://db.rstudio.com/dbi/) from RStudio. This allows ReviewR to interact with any database supported by DBI. A full list of compatible database back-ends[*](#dplyr-support) can be found [here](https://db.rstudio.com/databases/). 

Within ReviewR, DBI connection objects are programmatically created to facilitate user connections to patient databases. This connection object defines the type of database, connection information (ip, port, etc.), and the user with any associated credentials. These connection objects can then be used to create connections to tables within the database.

### Database Modules

ReviewR facilitates these DBI connections through the use of  [Shiny Modules](https://mastering-shiny.org/scaling-modules.html). Modules are a way to make a complex Shiny application more manageable. They help compartmentalize code and each module is developed for a specific purpose. At their core, modules take user inputs that are defined in a User Interface (UI) function, process the user inputs in a server function and return an output. Each module operates in its own namespace, meaning that shiny modules are portable and can be used in other applications and/or reusable within the same application. 

ReviewR has developed a way to interactively switch between database modules that have been developed for the package. These modules consist of a UI to guide the user through establishing a database connection and a server responsible for validating user inputs, establishing a connection, and returning a DBI connection object. Users can extend the functionality of ReviewR by adding developed database modules to `R/mod_database_setup.R` as shown below:

```{r eval=FALSE}
# Database Module Setup ----
      namespace <- 'db-selector-ns'
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Add Database Setup Modules Here!!! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
      ## Add Database Setup Modules Here
      database_setup_vars <- reactiveValues(bigquery = shinyBigQuery::bigquery_setup_server(id = namespace ),
                                            postgresql = shinyPostgreSQL::postgresql_setup_server(id = namespace ) #,
                                            # new_module = ReviewR::new_module_setup_server(id = namespace)
                                            )
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
```

Once modules are added to the package, they will appear in the Patient Database Module drop down on the setup tab. 
```{r echo=FALSE}
knitr::include_graphics('database_module.gif')
```

Read on to learn how to develop a database module for ReviewR!

<a name="dplyr-support"></a>
\**Note: Supported Databases must also have [dplyr](https://db.rstudio.com/dplyr) support.*

## Developing a Database Module for ReviewR

Creating a Shiny module is akin to developing a stand alone Shiny App. When developing for ReviewR, there are a few differences that result because of its package architecture. A [template](#reviewr-database-module-template) has been provided so that some aspects of ReviewR database module development can be highlighted. 

### Getting Started

The first step to developing a new ReviewR module will be to clone the latest version of ReviewR from GitHub. This will ensure you have access to the latest development tools and file structure of the ReviewR package. For simplicity, clone the repository to your home directory:
```{r eval=FALSE}
# install.packages('usethis')
usethis::create_from_github(repo_spec = 'thewileylab/ReviewR', destdir = '~/')
```

Navigate to the cloned directory and open the `ReviewR.Rproj` file. This will open the project in RStudio. Finally, using the devtools package run:
```{r eval=FALSE}
# install.packages('devtools')
devtools::load_all()
```

This will load the most recent version of ReviewR. At this point, you are ready to begin developing a database module.

### General Module Structure

Take note of the [ReviewR Database Module Template](#reviewr-database-module-template). It consists of 2 functions: 

* database_setup_ui - Defines the user interface that will guide someone through the database connection process
* database_setup_server - Defines what actions to take as a result of user inputs. 

ReviewR utilizes the [`moduleServer()`](https://shiny.rstudio.com/reference/shiny/1.5.0/moduleServer.html) function introduced in Shiny 1.5. This allows the server function of a module to be called within your application just like any other function, instead of relying on the previously awkward `callModule()` syntax. 

The next thing to note is that ReviewR modules will ultimately become a part of the ReviewR package namespace. This means that both the UI and Server functions require roxygen comments, with all function parameters, returns, and necessary package imports declared. 

For additional information on module development, please see: https://shiny.rstudio.com/articles/modules.html

### Requirements

* a ui function defined as `{module_name}_setup_ui` that accepts a single parameter (id)
* a server function defined as `{module_name}_setup_server` with a reactiveValues return
    + reactiveValues must contain the following variables, with initial values set
      + moduleName = 'Your Database Module Name'
      + moduleType = 'database'
      + setup_ui = ReviewR::database_setup_ui
      + is_connected = 'no'
      + db_con = NULL

### Module Workflow 

### Start Developing!

A helper function has been provided along with ReviewR to help jumpstart the process. Run:

```{r eval=FALSE}
ReviewR:::dev_database_module(mod_name = 'your_moudle', display_name = 'Your Module Display Name')
```

This will create a module file in the R/ directory of the ReviewR package and open it for editing. 

As you are developing/testing, remember to add your completed module to `/R/mod_database_setup.R` in order to have the module display within ReviewR. When incorporated into ReviewR, the `display_name` parameter will be what shows up in the Database Module Selector drop down list. When you are ready to test, be sure to run:

```{r eval=F}
golem::document_and_reload()
```

This will incorporate your newly developed module into the ReviewR namespace, allowing you to see any changes that you have made as a result of your development process. 

### Finishing up

Once you are satisfied with your module and have sufficiently tested its functionality, run:
```{r eval=FALSE}
devtools::install()
```

To install a new version of the ReviewR package with your newly developed module incorporated.

### ReviewR Database Module Template

```{r mod_database_module, eval=FALSE}
# UI ----
#' Database Setup UI
#'
#' This module is designed to guide a user through the process of authenticating your database
#'
#' @param id The module namespace
#' 
#' @return The Database Setup UI
#' @export
#' 
#' @importFrom any package imports required to render your Setup UI
#'
database_setup_ui <- function(id) { ## Enter a unique UI function name, ie: mariaDB_setup_ui
  ns <- NS(id)
  tagList(
    
    )
  }

# Server ----
#' Database Setup Server
#'
#' @param id The Module namespace
#'
#' @return Database connection variables
#' @export
#'
#' @importFrom any package imports required to process user entered information from the UI
#' 
database_setup_server <- function(id) {
  moduleServer(
    id,
    function(input, output, session) {
      ns <- session$ns
      ## Database Export Values ----
      database_export <- reactiveValues(
        ### Module Info
        moduleName = 'Your Database Module Name',
        moduleType = 'database',
        setup_ui = ReviewR::database_setup_ui, ## Make this function match your setup UI function
        is_connected = 'no',       
        db_con = NULL
        )
      # Server Code Here ----
      
      
      # Return ----
      return(database_export)
    }
  )
}
```

