---
title: "Support a New Relational Database Management System"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{add_a_database_module}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview

Database connections in ReviewR are created with the help of the [DBI Package](https://db.rstudio.com/dbi/) from RStudio. This allows ReviewR to interact with any database supported by DBI. A full list of compatible database back-ends[*](#dplyr-support) can be found [here](https://db.rstudio.com/databases/). 

Within ReviewR, DBI connection objects are programmatically created to facilitate user connections to patient databases. This connection object defines the type of database, connection information (ip, port, etc.), and the user with any associated credentials. These connection objects can then be used to create connections to tables within the database.

### Database Modules

ReviewR facilitates these DBI connections through the use of  [Shiny Modules](https://mastering-shiny.org/scaling-modules.html). Modules are a way to make a complex Shiny application more manageable. They help compartmentalize code and each module is developed for a specific purpose. At their core, modules take user inputs that are defined in a User Interface (UI) function, process the user inputs in a server function and return an output. Each module operates in its own namespace, meaning that shiny modules are portable and can be used in other applications and/or reusable within the same application. 

ReviewR has developed a way to interactively switch between database modules that have been developed for the package. These modules consist of a UI to guide the user through establishing a database connection and a server responsible for validating user inputs, establishing a connection, and returning a DBI connection object. Users can extend the functionality of ReviewR by adding developed database modules to `R/mod_database_setup.R` as shown below:

```{r eval=FALSE}
# Database Module Setup ----
      namespace <- 'db-selector-ns'
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Add Database Setup Modules Here!!! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
      ## Add Database Setup Modules Here
      database_setup_vars <- reactiveValues(bigquery = shinyBigQuery::bigquery_setup_server(id = namespace ),
                                            postgresql = shinyPostgreSQL::postgresql_setup_server(id = namespace )
                                            )
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
```

Once modules are added to the package, they will appear in the Patient Database Module drop down on the setup tab. 
```{r echo=FALSE}
knitr::include_graphics('database_module.gif')
```

Read on to learn how to develop a database module for ReviewR!

<a name="dplyr-support"></a>
\**Note: Supported Databases must also have [dplyr](https://db.rstudio.com/dplyr) support.*

## Developing a Database Module for ReviewR

### ReviewR Database Module Template
```{r mod_database_module, eval=FALSE}
# UI ----
#' Database Setup UI
#'
#' This module is designed to guide a user through the process of authenticating your database
#'
#' @param id The module namespace
#' 
#' @return The Database Setup UI
#' @export
#' 
#' @importFrom any package imports required to render your Setup UI
#'
database_setup_ui <- function(id) { ## Enter a unique UI function name, ie: mariaDB_setup_ui
  ns <- NS(id)
  tagList(
    
    )
  }

# Server ----
#' Database Setup Server
#'
#' @param id The Module namespace
#'
#' @return Database connection variables
#' @export
#'
#' @importFrom any package imports required to process user entered information from the UI
#' 
bigquery_setup_server <- function(id, secrets_json = '/srv/shiny-server/.shinyBigQuery/client_secret.json') {
  moduleServer(
    id,
    function(input, output, session) {
      ns <- session$ns
      ## Database Export Values ----
      database_export <- reactiveValues(
        ### Module Info
        moduleName = 'Your Database Module Name',
        moduleType = 'database',
        setup_ui = ReviewR::database_setup_ui, ## Make this function match your setup UI function
        is_connected = 'no',       
        db_con = NULL
        )
      # Server Code Here ----
      
      
      # Return ----
      return(database_export)
    }
  )
}
```

